<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Swiss Gov Spending (S13, 2022)</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
    }

    #chart {
      width: 960px;
      height: 600px;
      margin: auto;
    }

    .tooltip {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 14px;
      pointer-events: none;
      opacity: 0;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    text {
      font-size: 16px;
      fill: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px black;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Swiss Government Spending (S13, 2022) â€“ Top COFOG Categories</h2>
  <div id="chart"></div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    const width = 960;
    const height = 600;

    const svg = d3.select("#chart")
      .append("svg")
      .attr("width", width)
      .attr("height", height);

    const tooltip = d3.select("#tooltip");

    d3.csv("SwissGovSpend.csv.csv", d3.autoType).then(data => {
      const filtered = data.filter(d =>
        d.SECTOR === "S13" &&
        d.PERIOD === 2022 &&
        d.UNIT_MEAS === "MCHF" &&
        /^GF\d{2}$/.test(d.COFOG)
      );

      const labels = {
        "GF01": "General public services",
        "GF02": "Defence",
        "GF03": "Public order and safety",
        "GF04": "Economic affairs",
        "GF05": "Environmental protection",
        "GF06": "Housing and community amenities",
        "GF07": "Health",
        "GF08": "Recreation, culture and religion",
        "GF09": "Education",
        "GF10": "Social protection"
      };

      // Sort descending to put largest left-most
      filtered.sort((a, b) => b.VALUE - a.VALUE);

      const root = d3.hierarchy({
        name: "Swiss Gov Spending",
        children: filtered.map(d => ({
          name: labels[d.COFOG] || d.COFOG,
          value: d.VALUE
        }))
      }).sum(d => d.value);

      d3.treemap()
        .size([width, height])
        .padding(2)(root);

      const color = d3.scaleOrdinal()
        .domain(root.leaves().map(d => d.data.name))
        .range(d3.schemeCategory10);

      const nodes = svg.selectAll("g")
        .data(root.leaves())
        .enter()
        .append("g")
        .attr("transform", d => `translate(${d.x0},${d.y0})`);

      nodes.append("rect")
        .attr("width", d => d.x1 - d.x0)
        .attr("height", d => d.y1 - d.y0)
        .attr("fill", d => color(d.data.name))
        .on("mousemove", (event, d) => {
          tooltip.style("left", (event.pageX + 10) + "px")
                 .style("top", (event.pageY - 20) + "px")
                 .style("opacity", 1)
                 .html(`<strong>${d.data.name}</strong><br>${d.value.toLocaleString()} MCHF`);
        })
        .on("mouseout", () => tooltip.style("opacity", 0));

      nodes.append("text")
        .attr("x", 6)
        .attr("y", 20)
        .text(d => d.data.name);
    });
  </script>
</body>
</html>
