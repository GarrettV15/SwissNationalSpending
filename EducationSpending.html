<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>PISA Scores vs. Education Spending</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background: #fafafa;
        }

        .line {
            fill: none;
            stroke-width: 2.5px;
        }

        .axis-label {
            font-size: 12px;
        }

        .legend text {
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h2 style="text-align:center;">Average Swiss PISA Scores vs. Education Spending (MCHF)</h2>
    <svg width="900" height="550"></svg>

    <script>
        Promise.all([
            d3.csv("swiss_pisa_summary.csv", d3.autoType),
            d3.csv("SwissGovSpend.csv.csv", d3.autoType),
            d3.text("WorldPopulationData.csv"),
            d3.csv("SwissInflationData.csv", d3.autoType)
        ]).then(([pisaData, spendRaw, popText, infData]) => {
            const lines = popText.split("\n");
            const headerIndex = lines.findIndex(line => line.startsWith('"Country Name"'));
            const worldData = d3.csvParse(lines.slice(headerIndex).join("\n"));
            const switz = worldData.find(d => d["Country Name"] === "Switzerland");
            const popMap = {};
            for (let y = 1995; y <= 2025; y++) popMap[y] = +switz[y];

            const eduSpend = spendRaw.filter(d =>
                d.COFOG === "GF01" &&
                d.UNIT_MEAS === "MCHF" &&
                d.SECTOR === "S13"
            ).map(d => ({
                Year: +d.PERIOD,
                Value: +d.VALUE,
                Population: popMap[+d.PERIOD]
            })).filter(d => d.Population);

            eduSpend.forEach(d => {
                d.NominalPerCapita = (d.Value * 1e6) / d.Population;
            });

            const inflationMap = {};
            infData.forEach(d => {
                inflationMap[+d["Year"]] = +d["Inflation Rate"];
            });

            const baseYear = 2003;
            const inflationIndex = {};
            inflationIndex[baseYear] = 1.0;
            for (let y = baseYear + 1; y <= 2025; y++) {
                inflationIndex[y] = inflationIndex[y - 1] * (1 + (inflationMap[y] || 0) / 100);
            }
            for (let y = baseYear - 1; y >= 1995; y--) {
                inflationIndex[y] = inflationIndex[y + 1] / (1 + (inflationMap[y + 1] || 0) / 100);
            }

            eduSpend.forEach(d => {
                const deflator = inflationIndex[d.Year] || 1;
                d.RealPerCapita = d.NominalPerCapita / deflator;
            });

            const merged = pisaData.map(d => {
                const spend = eduSpend.find(e => e.Year === d.Year);
                return spend ? {
                    ...d,
                    RealPerCapita: spend.RealPerCapita
                } : null;
            }).filter(d => d);

            const svg = d3.select("svg"),
                margin = { top: 60, right: 100, bottom: 60, left: 60 },
                width = +svg.attr("width") - margin.left - margin.right,
                height = +svg.attr("height") - margin.top - margin.bottom;

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain(d3.extent(merged, d => d.Year))
                .range([0, width]);

            const yLeft = d3.scaleLinear()
                .domain([
                    d3.min(merged, d => Math.min(d.avg_math, d.avg_read, d.avg_science)) - 5,
                    d3.max(merged, d => Math.max(d.avg_math, d.avg_read, d.avg_science)) + 5
                ])
                .range([height, 0]);

            const yRight = d3.scaleLinear()
                .domain([0, d3.max(merged, d => d.RealPerCapita) * 1.1])
                .range([height, 0])
                .nice();

            const color = d3.scaleOrdinal()
                .domain(["avg_math", "avg_read", "avg_science", "RealPerCapita"])
                .range(["steelblue", "darkorange", "green", "crimson"]);

            const line = (key, scale) => d3.line()
                .x(d => x(d.Year))
                .y(d => scale(d[key]));

            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickFormat(d3.format("d")));

            g.append("g")
                .call(d3.axisLeft(yLeft))
                .append("text")
                .attr("x", -height / 2)
                .attr("y", -45)
                .attr("fill", "black")
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .style("font-size", "16px")
                .text("Average PISA Scores");

            const yRightAxis = g.append("g")
                .attr("transform", `translate(${width},0)`)
                .call(d3.axisRight(yRight));

            svg.append("text")
                .attr("x", width + margin.left + 50)
                .attr("y", height / 2 + margin.top)
                .attr("fill", "crimson")
                .attr("text-anchor", "middle")
                .attr("transform", `rotate(90, ${width + margin.left + 50}, ${height / 2 + margin.top})`)
                .style("font-size", "16px")
                .text("Education Spending per Capita (CHF, 2003)");


            ["avg_math", "avg_read", "avg_science"].forEach(key => {
                g.append("path")
                    .datum(merged)
                    .attr("fill", "none")
                    .attr("stroke", color(key))
                    .attr("stroke-width", 2.5)
                    .attr("d", line(key, yLeft));
            });

            g.append("path")
                .datum(merged)
                .attr("fill", "none")
                .attr("stroke", color("RealPerCapita"))
                .attr("stroke-width", 3)
                .attr("stroke-dasharray", "5 3")
                .attr("d", line("RealPerCapita", yRight));

            svg.append("text")
                .attr("x", svg.attr("width") / 2)
                .attr("y", 30)
                .attr("text-anchor", "middle")
                .style("font-size", "20px")
                .style("font-weight", "bold")
                .text("Average Swiss PISA Scores vs. Real Education Spending per Capita (in 2003 CHF)");

            // === Tooltip ===
            const tooltip = d3.select("body").append("div")
                .attr("id", "tooltip")
                .style("position", "absolute")
                .style("padding", "8px")
                .style("background", "white")
                .style("border", "1px solid #ccc")
                .style("border-radius", "4px")
                .style("pointer-events", "none")
                .style("opacity", 0);

            // === Add circles for hover ===
            g.selectAll(".hover-circle")
                .data(merged)
                .enter()
                .append("circle")
                .attr("cx", d => x(d.Year))
                .attr("cy", d => yRight(d.RealPerCapita))
                .attr("r", 3.5)
                .attr("fill", "crimson")
                .attr("stroke", "#333")
                .attr("stroke-width", 1)
                .on("mouseover", function (event, d) {
                    tooltip.transition().duration(200).style("opacity", 0.95);
                    tooltip.html(
                        `<strong>Year:</strong> ${d.Year}<br/>
   <strong>Real CHF per Cap:</strong> ${d.RealPerCapita.toFixed(2)}<br/>
   <strong>Math:</strong> ${d.avg_math.toFixed(2)}<br/>
   <strong>Reading:</strong> ${d.avg_read.toFixed(2)}<br/>
   <strong>Science:</strong> ${d.avg_science.toFixed(2)}`
                    )

                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function () {
                    tooltip.transition().duration(300).style("opacity", 0);
                });

            const labels = {
                avg_math: "Math Score",
                avg_read: "Reading Score",
                avg_science: "Science Score",
                RealPerCapita: "Real Per Capita Spending (2003 CHF)"
            };

            const legend = svg.append("g")
                .attr("transform", `translate(${margin.left}, ${height + margin.top + 30})`);

            Object.keys(labels).forEach((key, i) => {
                const xOffset = i * 200;
                legend.append("circle")
                    .attr("cx", xOffset)
                    .attr("cy", 0)
                    .attr("r", 5)
                    .attr("fill", color(key));
                legend.append("text")
                    .attr("x", xOffset + 10)
                    .attr("y", 4)
                    .text(labels[key])
                    .style("font-size", "13px");
            });
        });
    </script>







</body>

</html>